{% extends "base.html" %}
 
{% block content %}
<div class="container mt-4 model-fade-in container-color">
    <!-- Title and Brand-Wise Intro -->
    <div class="mt-4 mb-4 p-3">
        <h2 class="text-center">Region-Wise Sales Forecasting Dashboard</h2>
        <p>
            <p>
This dashboard presents monthly sales predictions for each region, generated by an advanced XGBoost model.
Historical regional sales, seasonal trends, and market patterns are used to forecast future performance.
Compare Actual vs Predicted values to evaluate accuracy, and explore the 8-month forecast to support inventory planning, resource allocation, and regional marketing strategies.
Sales values are displayed in millions for easier interpretation.
    </p>
        </p>
    </div>

    <div class="mb-5 text-center">
        <h3>Features</h3>
        <div class="row mt-4">
        <div class="col-md-4 mb-3">
            <img src="/static/Images/divisiongranularity.png" alt="Division-Wise granularity" class="img-fluid mb-2 icons-sku">
            <h5>Division-Wise granularity</h5>
            <p>The division level filter provides a deeper layer of granularity in our region model </p>
        </div>
        <div class="col-md-4 mb-3">
            <img src="/static/Images/regionalcampaign.png" alt="Regional-Campaign" class="img-fluid mb-2 icons-sku">
            <h5>Tailored Regional Campaign</h5>
            <p>By understanding the region sales patterns, it allows for region-specific promotions and planning</p>
        </div>
        <div class="col-md-4 mb-3">
            <img src="/static/Images/inventory.png" alt="Inventory" class="img-fluid mb-2 icons-sku">
            <h5>Optimized Inventory Allocation</h5>
            <p>Allows better stock distribution across warehouses.</p>
        </div>
        </div>
    </div>

    <!-- Division Logos -->
    <div class="text-center mt-3">
        <img src="{{ url_for('static', filename='images/CANDYLAND_LOGO.png') }}"
            alt="Candyland"
            class="division-logo"
            onclick="loadDivision('CANDYLAND')">
 
        <img src="{{ url_for('static', filename='images/BISCONNI_LOGO.png') }}"
            alt="Bisconni"
            class="division-logo"
            onclick="loadDivision('BISCONNI')">
    </div>
     
    <div id="dataSection" style="position: relative;">
        <!-- Loader -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <p>Loading data, please wait...</p>
        </div>
 
        <!-- Actual vs Predicted Table -->
        <div id="tableWrapper" class="mt-4">
            <h3 class="text-center">Actual vs Predicted Sales (Test Data)</h3>
            <div class="row">
                <!-- North Table -->
                <div class="col-md-6">
                    <h5 class="text-center">North</h5>
                    <table id="northTable" class="table table-striped table-bordered">
                        <thead style="background-color: #0d3b66; color: #ffffff;">
                            <tr>
                                <th>Date</th>
                                <th>Actual Sales (Million)</th>
                                <th>Predicted Sales (Million)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
 
                <!-- South Table -->
                <div class="col-md-6">
                    <h5 class="text-center">South</h5>
                    <table id="southTable" class="table table-striped table-bordered">
                        <thead style="background-color: #0d3b66; color: #ffffff;">
                            <tr>
                                <th>Date</th>
                                <th>Actual Sales (Million)</th>
                                <th>Predicted Sales (Million)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
 
            <!-- Legend for cell colors -->
            <div class="text-center mt-2">
                <small>
                    <span style="background-color:#f8d7da; color:#721c24; padding:3px 8px; border-radius:4px; margin-right:10px;">
                        ðŸ”´ Underprediction (Predicted &lt; Actual)
                    </span>
                    <span style="background-color:#d4edda; color:#155724; padding:3px 8px; border-radius:4px;">
                        ðŸŸ¢ Overprediction (Predicted â‰¥ Actual)
                    </span>
                </small>
            </div>
        </div>
 
        <!-- Forecast Chart -->
        <div id="chartWrapper" class="mt-4" style="height: 400px; width: 100%;">
            <h3>8-Month Sales Forecast by Region</h3>
            <canvas id="forecastChart"></canvas>
        </div>

        <!-- ðŸ“Š 2024 Actual Sales Bar Chart -->
        <div id="actual2024Wrapper" class="card mt-4"  style =" height: 400px; width: 100%;">
                <h3>2024 Actual Sales</h3>
                <canvas id="actualChart"></canvas>
        </div>
    </div>
</div>
 
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
<script>
document.addEventListener("DOMContentLoaded", function() {
 
    let forecastChartInstance = null;
   
        let actualChartInstance = null; // store actual chart instance globally
    function setActiveLogo(activeBtn) {
        document.querySelectorAll('.division-logo').forEach(logo => {
            logo.classList.remove('selected');
        });
        activeBtn.classList.add('selected');
    }
 
    function formatMillions(num) {
        return (num / 1_000_000).toFixed(3) + " M";
    }
 
    // Helper: style predicted cell based on comparison
    function getPredictedCell(actual, predicted) {
        const color = predicted < actual
            ? "style='background-color:#f8d7da; color:#a94442;'"
            : "style='background-color:#d4edda; color:#2e7d32;'";
        return `<td ${color}>${formatMillions(predicted)}</td>`;
    }
 
    window.loadDivision = function(division) {
        const activeLogo = Array.from(document.querySelectorAll('.division-logo'))
            .find(img => img.alt.toUpperCase() === division);
        if (activeLogo) setActiveLogo(activeLogo);
 
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = 'flex';
 
        const url = division
            ? `/region-forecast?division=${encodeURIComponent(division)}`
            : `/region-forecast`;
 
        fetch(url)
            .then(res => res.json())
            .then(data => {
                renderForecast(data);
                renderActual(data.actual_data);
            })
            .catch(err => console.error('Error loading division:', err))
            .finally(() => overlay.style.display = 'none');
    };
 
    function renderForecast(data) {
        console.log("Backend full payload:", data);
        console.log("Actual JSON from backend:", data.actual);
        const records = data.data || [];
        document.getElementById("tableWrapper").classList.remove("fade-in");
        document.getElementById("chartWrapper").classList.remove("fade-in");
        void document.getElementById("tableWrapper").offsetWidth;
        void document.getElementById("chartWrapper").offsetWidth;
 
        const actualData = records.filter(r => r.TYPE === "Actual_vs_Predicted");
        const forecastData = records;
 
        function formatDateLabel(dateStr) {
            const dateObj = new Date(dateStr);
            return dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
        }
       
        const northData = actualData.filter(row => row.REGION.toLowerCase().includes("north"));
        const southData = actualData.filter(row => row.REGION.toLowerCase().includes("south"));
 
        // Populate North table
        const northBody = document.querySelector("#northTable tbody");
        northBody.innerHTML = '';
        northData.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${formatDateLabel(row.DATE)}</td>
                <td>${formatMillions(row.MONTHLY_SALES)}</td>
                ${getPredictedCell(row.MONTHLY_SALES, row.PREDICTED_SALES)}
            `;
            northBody.appendChild(tr);
        });
 
        // Populate South table
        const southBody = document.querySelector("#southTable tbody");
        southBody.innerHTML = '';
        southData.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${formatDateLabel(row.DATE)}</td>
                <td>${formatMillions(row.MONTHLY_SALES)}</td>
                ${getPredictedCell(row.MONTHLY_SALES, row.PREDICTED_SALES)}
            `;
            southBody.appendChild(tr);
        });
 
        document.getElementById("tableWrapper").classList.add("fade-in");
        document.getElementById("chartWrapper").classList.add("fade-in");
 
        if (forecastData.length === 0) return;
 
        const regions = [...new Set(forecastData.map(r => r.REGION))];
        const dates = [...new Set(forecastData.map(r => r.DATE))].sort();
        const dateLabels = dates.map(d => {
            const dateObj = new Date(d);
            return dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
        });
 
        const colors = ['blue', 'green', 'orange', 'purple', 'red', 'brown', 'cyan', 'magenta'];
 
        const datasets = regions.map((region, idx) => {
            const regionData = dates.map(date => {
                const found = forecastData.find(r => r.REGION === region && r.DATE === date);
                return found ? found.PREDICTED_SALES / 1_000_000 : null;
            });
            return {
                label: region,
                data: regionData,
                borderColor: colors[idx % colors.length],
                fill: false,
                tension: 0.2,
                opacity:0.2
            };
        });
 
        if (forecastChartInstance) {
            forecastChartInstance.data.labels = dateLabels;
            forecastChartInstance.data.datasets = datasets;
            forecastChartInstance.update();
        } else {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            forecastChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: dateLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800, easing: 'easeInOutCubic' },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "Sales (Million)" },
                            ticks: { callback: val => val.toFixed(3) + " M" }
                        },
                        x: { type: 'category', ticks: { autoSkip: false, maxTicksLimit: 10 } }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ": " + ctx.raw.toFixed(3) + " M" }
                        }
                    },
                    layout: { padding: { bottom: 40 } }
                }
            });
        }
        console.log("Test RÂ²:", data.test_r2);
    }

    function renderActual(actualData) {
        if (!actualData || actualData.length === 0) return;

        // Extract unique months and sort numerically
        const months = [...new Set(actualData.map(r => r.MONTH))].sort((a, b) => a - b);
        const monthLabels = months.map(m => "Month " + m);

        // Prepare North and South datasets for chart
        const northData = months.map(m => {
            const row = actualData.find(r => r.REGION.toLowerCase().includes("north") && r.MONTH === m);
            return row ? row.MONTHLY_SALES / 1_000_000 : null;
        });

        const southData = months.map(m => {
            const row = actualData.find(r => r.REGION.toLowerCase().includes("south") && r.MONTH === m);
            return row ? row.MONTHLY_SALES / 1_000_000 : null;
        });

        // Prepare chart datasets
        const datasets = [
            { label: "North", data: northData, borderColor: "blue", fill: false, tension: 0.2 },
            { label: "South", data: southData, borderColor: "green", fill: false, tension: 0.2 }
        ];

        // Destroy previous chart if exists
        if (actualChartInstance) actualChartInstance.destroy();

        // Create chart
        const ctx = document.getElementById("actualChart").getContext("2d");
        actualChartInstance = new Chart(ctx, {
            type: "line",
            data: { labels: monthLabels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 800, easing: 'easeInOutCubic' },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: "Sales (Million)" },
                        ticks: { callback: val => val.toFixed(3) + " M" }
                    },
                    x: { type: "category", ticks: { autoSkip: false, maxTicksLimit: 12 } }
                },
                plugins: {
                    legend: { position: "top" },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + ctx.raw.toFixed(3) + " M" } }
                },
                layout: { padding: { bottom: 40 } }
            }
        });
    }

    loadDivision('CANDYLAND');
});
</script>
{% endblock %}