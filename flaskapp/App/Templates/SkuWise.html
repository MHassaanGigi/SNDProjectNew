{% extends "base.html" %}

{% block content %}
<div class="container mt-5 model-fade-in">

  <!-- 1ï¸âƒ£ Page Title & Use Case -->
  <div class="text-center">
    <h1>Town-Based SKU Pattern Recognition & Prediction</h1>
  </div>

  <!-- 2ï¸âƒ£ Short Description -->
  <div class="mb-5 text-center">
    <p>We focus on a set of representative SKUs to understand patterns and forecast future sales. This allows businesses to make informed decisions on stocking and product launches.For this Model, we have selected Stock Keeping Units (SKUs) that match the description 24 BAGS X 24 BOXES. Below are the brands/products that have an sku which matches this description</p>
  </div>

  <!-- 3ï¸âƒ£ Example SKU Patterns Selection -->
  <div class="mb-5">
    <h3 class="mb-3 text-center">Selected Products</h3>
    <div class="row text-center g-3 justify-content-center">
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>ABC JELLY</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>BOTTLE JELLY</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>CHILLI MILLI</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>DINO JELLY</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>FIZZY O JELLY</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>SOUR ABC JELLY</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>SOUR BEAR JELLY</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>SOUR BITES JELLY</sku>
        </div>
      </div>
      <div class="col-4">
        <div class="sku-box p-3 shadow-sm rounded-circle">
          <sku>SWEET BEAR JELLY</sku>
        </div>
      </div>
    </div>
  </div>

  <!-- 4ï¸âƒ£ Three-Segment SKU Selection Reasoning -->
  <div class="mb-5 text-center">
    <h3>Why These SKUs?</h3>
    <div class="row mt-4">
      <div class="col-md-4 mb-3">
        <img src="/static/Images/price.png" alt="Price" class="img-fluid mb-2 icons-sku">
        <h5>Similar Price Points</h5>
        <p>Allows fair comparison and pattern recognition across products.</p>
      </div>
      <div class="col-md-4 mb-3">
        <img src="/static/Images/packaging.png" alt="Packaging" class="img-fluid mb-2 icons-sku">
        <h5>Similar Packaging</h5>
        <p>Visual and size similarity helps assess consumer preferences.</p>
      </div>
      <div class="col-md-4 mb-3">
        <img src="/static/Images/demand.png" alt="Demand" class="img-fluid mb-2 icons-sku">
        <h5>High Demand Stability</h5>
        <p>Consistent sales make forecasting models more reliable.</p>
      </div>
    </div>
  </div>

  <!-- 5ï¸âƒ£ What is 1 Unit -->
   <div class="mb-5 text-center">
    <h3>Whhat are we considering 1 Unit?</h3>
    <div class="row align-items-center mb-4">
      <!-- Image -->
      <div class="col-md-4 mb-3 ">
        <img src="/static/Images/24x24.png" alt="ABC Jelly BOX" class="img-fluid mb-2"  style="max-width: 250px; height: auto; margin-right: 15px;">
      </div>

      <!-- Text -->
      <div class="col-md-8">
        <p>
          This 1 box represents what we have considered to be as one unit in our model.
        </p>
      </div>
    </div>
  </div>

  <!-- 5ï¸âƒ£ Models Used -->
  <div class="mb-5 text-center">
    <h3>Forecasting Models</h3>
    <p>We used Random Forest and XGBoost due to their ability to handle complex, non-linear relationships in sales data. The below table shows the accuracy and precision of the models in accordance to the actual dataset</p>
  </div>

   <!-- 6ï¸âƒ£b Forecast Line Chart -->
  <div class="mb-5">
    <h3 class="text-center">2025 Forecast</h3>
    <div style="height:400px;">
      <canvas id="forecastChart"></canvas>
    </div>
  </div>

  <!-- 6ï¸âƒ£ Comparison Table -->
  <div class="mb-5">
    <h3>Actual vs Predicted Unit Sold</h3>
    <table id="testPredictedTable" class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Month</th>
          <th>Actual Units Sold</th>
          <th>Predicted Units Sold (XGBoost)</th>
          <th>Predicted Units Sold (RandomForest)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 8ï¸âƒ£ Town Breakdown -->
  <div class="mb-5">
    <h3 class="text-center">Town-Wise Units Distribution</h3>
    <div class="mt-4 mb-4 d-flex justify-content-center">
      <div style="max-width: 400px; width: 100%; height: 400px;">
        <canvas id="townPieChart"></canvas>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6" style="height: 400px;">
        <h5>Town Ã— Random Forest</h5>
        <canvas id="townChartRF"></canvas>
      </div>
      <div class="col-md-6" style="height: 400px;">
        <h5>Town Ã— XGBoost</h5>
        <canvas id="townChartXGB"></canvas>
      </div>
    </div>
  </div>
    <!-- 7ï¸âƒ£ Uses / Business Value -->
  <div class="mb-5 text-center">
    <h3>Business Applications</h3>
    <div class="row mt-4">
      <div class="col-md-6 mb-3 text-center">
        <img src="/static/Images/stockkeeping.png" alt="stockkeeping" class="img-fluid mb-2 icons-sku-2">
        <h5>Stockkeeping & Resource Management</h5>
        <p>Plan inventory better, optimize stock levels, and reduce wastage.</p>
      </div>
      <div class="col-md-6 mb-3 text-center">
        <img src="/static/Images/product_launch.png" alt="Product Launch" class="img-fluid mb-2 icons-sku-2">
        <h5>Launching New Products</h5>
        <p>Predict potential demand for similar products in target towns and regions.</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const getVal = (obj, keys) => {
        for (const k of keys) {
            if (k in obj && obj[k] !== null && obj[k] !== undefined) return obj[k];
        }
        return '';
    };

    const fetchJson = (url) =>
        fetch(url).then(res => {
            if (!res.ok) return res.json().then(err => { throw err; });
            return res.json();
        });

    fetchJson('/run-forecasting')
        .then(data => {
            console.log("ðŸ“¦ Unified forecast payload:", data);
            if (!data || typeof data !== 'object') return;

            // --- 1ï¸âƒ£ Populate comparison table ---
            const tableBody = document.querySelector("#testPredictedTable tbody");
            tableBody.innerHTML = '';
            data.comparison.forEach(row => {
                const Month = getVal(row, ['MONTH','Month','month']);
                const actual = getVal(row, ['Actual','ACTUAL','actual']);
                const xgb = getVal(row, ['XGBoost','xgboost','XGB','Predicted_XGB']);
                const rf = getVal(row, ['RandomForest','randomforest','RF','Predicted_RF']);
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${Month}</td><td>${actual}</td><td>${xgb}</td><td>${rf}</td>`;
                tableBody.appendChild(tr);
            });

            // --- 2ï¸âƒ£ Full Forecast Line Chart ---
            data.monthly.sort((a, b) => new Date(a.month_date) - new Date(b.month_date));
            const labelsMonthly = data.monthly.map(r => getVal(r, ['MONTH','Month','month']));
            const rfDataMonthly = data.monthly.map(r => Number(getVal(r, ['Predicted_RF','PREDICTED_RF','RF_PRED'])) || null);
            const xgbDataMonthly = data.monthly.map(r => Number(getVal(r, ['Predicted_XGB','PREDICTED_XGB','XGB_PRED'])) || null);

            new Chart(document.getElementById('forecastChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labelsMonthly,
                    datasets: [
                        { label: 'Random Forest', data: rfDataMonthly, borderColor: '#0B1957', backgroundColor: 'transparent', fill: false },
                        { label: 'XGBoost', data: xgbDataMonthly, borderColor: '#9ECCFA', backgroundColor: 'transparent', fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    layout: { padding: { top: 20, right: 20, bottom: 20, left: 10 } },
                    scales: {
                        y: { title: { display: true, text: 'Units Sold' }, ticks: { callback: v => (v/1_000_000).toFixed(1)+'M' } },
                        x: { title: { display: true, text: 'Month' } }
                    }
                }
            });

            // --- 3ï¸âƒ£ Color Palettes ---
            const townColors = ['#F6D55C', '#ED553B', '#3CAEA3', '#20639B', '#173F5F', '#F0EDEE'];

            // --- 6ï¸âƒ£ Town Ã— Random Forest ---
            const townLabels = [...new Set(data.TownRecords.map(r => getVal(r, ['MONTH','Month','month'])))];
            const towns = [...new Set(data.TownRecords.map(r => getVal(r, ['TOWN','town','Town'])))];

            const rfTownDatasets = towns.map((town, idx) => {
                const values = townLabels.map(month => {
                    const row = data.TownRecords.find(r => getVal(r, ['TOWN','town','Town'])===town && getVal(r, ['MONTH','Month','month'])===month);
                    return row ? Number(getVal(row, ['Predicted_RF','PREDICTED_RF','RF_PRED'])) : 0;
                });
                return { label: town, data: values, borderColor: townColors[idx % townColors.length], fill: false };
            });

            new Chart(document.getElementById('townChartRF').getContext('2d'), {
                type: 'line',
                data: { labels: townLabels, datasets: rfTownDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { title: { display: true, text: 'Units Sold' } }, x: { title: { display: true, text: 'Month' } } }
                }
            });

            // --- 7ï¸âƒ£ Town Ã— XGBoost ---
            const xgbTownDatasets = towns.map((town, idx) => {
                const values = townLabels.map(month => {
                    const row = data.TownRecords.find(r => getVal(r, ['TOWN','town','Town'])===town && getVal(r, ['MONTH','Month','month'])===month);
                    return row ? Number(getVal(row, ['Predicted_XGB','PREDICTED_XGB','XGB_PRED'])) : 0;
                });
                return { label: town, data: values, borderColor: townColors[idx % townColors.length], fill: false };
            });

            new Chart(document.getElementById('townChartXGB').getContext('2d'), {
                type: 'line',
                data: { labels: townLabels, datasets: xgbTownDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { title: { display: true, text: 'Units Sold' } }, x: { title: { display: true, text: 'Month' } } }
                }
            });
              // --- 6ï¸âƒ£ Town Pie Chart (using RF totals) ---
              const townTotals = towns.map(town => {
                  return data.TownRecords
                      .filter(r => getVal(r, ['TOWN','town','Town']) === town)
                      .reduce((sum, row) => sum + Number(getVal(row, ['Predicted_RF','PREDICTED_RF','RF_PRED'])), 0);
              });

              new Chart(document.getElementById('townPieChart').getContext('2d'), {
                  type: 'pie',
                  data: {
                      labels: towns,
                      datasets: [{
                          data: townTotals,
                          backgroundColor: townColors
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: { position: 'top' },
                          tooltip: { callbacks: {
                              label: function(context) {
                                  return context.label + ': ' + context.raw.toLocaleString() + ' units';
                              }
                          }}
                      }
                  }
              });

        })
        .catch(err => {
            console.error('ðŸ’¥ Error fetching unified forecast:', err);
        });
});
</script>
{% endblock %}
